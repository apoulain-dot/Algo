name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  security-and-quality:
    runs-on: ubuntu-latest
    
    steps:
    # Ã‰tape 1: RÃ©cupÃ©rer le code
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Important pour Gitleaks (analyse historique Git)
    
    # Ã‰tape 2: Configuration Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    # Ã‰tape 3: Installation des dÃ©pendances
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit pylint safety
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    # Ã‰tape 4: Pylint (qualitÃ© de code)
    - name: Run Pylint
      run: |
        pylint $(find . -name "*.py" | grep -v venv) --exit-zero --output-format=text | tee pylint-report.txt
      continue-on-error: true
    
    # Ã‰tape 5: Bandit (sÃ©curitÃ© du code)
    - name: Run Bandit Security Scan
      run: |
        bandit -r . -f txt -o bandit-report.txt -x ./venv,./tests || true
        cat bandit-report.txt
      continue-on-error: true
    
    # Ã‰tape 6: Safety (vulnÃ©rabilitÃ©s des dÃ©pendances)
    - name: Run Safety Check
      run: |
        safety check --output text | tee safety-report.txt || true
      continue-on-error: true
    
    # ðŸ†• Ã‰tape 7: Gitleaks (dÃ©tection de secrets dans l'historique Git)
    - name: Run Gitleaks Secret Scan
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
    
    # ðŸ†• Ã‰tape 8: Trivy (scan vulnÃ©rabilitÃ©s filesystem + dÃ©pendances)
    - name: Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        output: 'trivy-report.txt'
      continue-on-error: true
    
    # ðŸ†• Ã‰tape 9: Semgrep (SAST avancÃ©)
    - name: Run Semgrep Static Analysis
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/python
      continue-on-error: true
    
    # Ã‰tape 10: Upload des rapports
    - name: Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.txt
          pylint-report.txt
          safety-report.txt
          trivy-report.txt
